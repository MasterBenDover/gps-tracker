<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<title>GPS Tracker — Modern Glass</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

<style>
:root {
  --bg: #0b0f14;
  --panel: rgba(255,255,255,0.05);
  --muted: #9aa7b2;
  --accent: #6a0dad;
  --green: #00ff55;
  --glass: rgba(255, 255, 255, 0.1);
  --btn-hover: rgba(255, 255, 255, 0.15);
}

html, body {
  margin:0; padding:0; height:100%;
  font-family:'Inter',sans-serif;
  background:var(--bg); color:#e6eef6;
}

#map { position: fixed; inset:0; }

/* ---- TOPBAR ---- */

.topbar {
  position: absolute; top:12px; left:12px; z-index:999;
  background: var(--panel); border-radius:20px; padding:16px;
  display:flex; gap:14px; flex-wrap:wrap;
  backdrop-filter: blur(20px) saturate(180%);
  box-shadow: 0 16px 40px rgba(0,0,0,0.7);
  transition: all 0.35s ease;
}

.topbar.hidden {
  opacity: 0;
  transform: translateY(-20px);
  pointer-events: none;
}

.topbar button, .topbar input, .topbar select {
  background: var(--glass);
  border:none; color:#e6eef6;
  padding:12px 18px;
  border-radius:14px;
  font-size:14px;
  cursor:pointer;
  position: relative;
  overflow: hidden;
  transition: all 0.35s cubic-bezier(0.4,0,0.2,1);
}

.topbar button:hover {
  background: var(--btn-hover);
  transform: translateY(-2px);
}

/* Shine swipe effect */
.topbar button::after {
  content: "";
  position: absolute;
  top: 0;
  left: -120%;
  width: 80%;
  height: 100%;
  background: linear-gradient(120deg,
    transparent 30%,
    rgba(255,255,255,0.3) 50%,
    transparent 70%
  );
  transform: skewX(-25deg);
  transition: all 0.7s ease;
}
.topbar button:hover::after {
  left: 120%;
}

/* ---- TOGGLE BUTTON ---- */

.toggleTopbar {
  position: absolute;
  top: 12px;
  right: 12px;
  z-index: 1000;
  width: 44px;
  height: 44px;
  border: none;
  border-radius: 14px;
  background: rgba(255,255,255,0.12);
  backdrop-filter: blur(18px) saturate(160%);
  color: white;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
}
.toggleTopbar:hover {
  background: rgba(255,255,255,0.18);
}

/* ---- TOAST ---- */

#notifyContainer {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 99999;
  pointer-events: none;
}

.notifyToast {
  min-width: 180px;
  text-align: center;
  padding: 12px 18px;
  border-radius: 16px;
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(18px) saturate(160%);
  color: #fff;
  font-size: 14px;
  opacity: 0;
  transform: translateY(15px);
  transition:
    opacity 0.6s cubic-bezier(0.25, 0.1, 0.25, 1),
    transform 0.6s cubic-bezier(0.25, 0.1, 0.25, 1);
}

.notifyToast.show { opacity:1; transform:translateY(0); }
.notifyToast.hide { opacity:0; transform:translateY(20px); }

</style>
</head>

<body>

<div id="map"></div>
<div id="notifyContainer"></div>

<div class="topbar">
  <button id="startBtn">Starta inspelning</button>
  <button id="stopBtn" disabled>Stoppa inspelning</button>
  <input id="routeName" placeholder="Namn på rutt" />
  <button id="saveBtn" disabled>Spara Rutt</button>
  <button id="setTokenBtn">Token</button>
  <select id="routeSelect"></select>
  <button id="loadBtn">Ladda rutt</button>
  <button id="resetProgressBtn">Reset progress</button>
  <button id="followBtn">Följ: På</button>
</div>

<button id="toggleTopbar" class="toggleTopbar">≡</button>

<script>

/* ---------------- INIT BLOCK ---------------- */
if (localStorage.getItem("location_allowed") === "1") {
  navigator.geolocation.getCurrentPosition(()=>{},()=>{},{
    enableHighAccuracy:true
  });
} else {
  navigator.geolocation.getCurrentPosition(
    () => { localStorage.setItem("location_allowed", "1"); },
    () => {},
    { enableHighAccuracy: true }
  );
}

/* -------------- START OF MAIN APP ------------ */
(() => {

/* ---- Smooth Toast ---- */
const notify = msg => {
  const c = document.getElementById("notifyContainer");
  const t = document.createElement("div");
  t.className="notifyToast"; t.textContent=msg;
  c.appendChild(t);
  void t.offsetWidth;
  t.classList.add("show");
  setTimeout(()=>{t.classList.remove("show");t.classList.add("hide");
    setTimeout(()=>t.remove(),600);
  },2000);
};

/* ---- APP STATE ---- */

const CFG={owner:'MasterBenDover',repo:'gps-tracker',folder:'routes'};
const S={
  pat:sessionStorage.getItem('gh_pat')||null,
  rec:false,
  watchId:null,
  liveWatch:null,
  autoFollow:true,
  currentPoints:[],
  loaded:null, loadedPath:null,
  segments:[], completed:[],
  lastHeading:0
};

const $=id=>document.getElementById(id);
const UI={
  start:$('startBtn'), stop:$('stopBtn'), save:$('saveBtn'),
  setToken:$('setTokenBtn'), select:$('routeSelect'),
  load:$('loadBtn'), name:$('routeName'),
  reset:$('resetProgressBtn'), follow:$('followBtn')
};

const b64={enc:s=>btoa(unescape(encodeURIComponent(s))),
           dec:b=>decodeURIComponent(escape(atob(b)))};

const hav=(a,b)=>{
  const R=6371000,rad=x=>x*Math.PI/180;
  const dLat=rad(b.lat-a.lat),dLon=rad(b.lon-a.lon);
  const la1=rad(a.lat),la2=rad(b.lat);
  const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
};

/* ---- GitHub API ---- */

const gh=async(p,m='GET',body=null)=>{
  const h={Accept:'application/vnd.github.v3+json'};
  if(S.pat) h.Authorization='token '+S.pat;
  if(body) h['Content-Type']='application/json';
  const r=await fetch(`https://api.github.com${p}`,{
    method:m, headers:h,
    body: body ? JSON.stringify(body):undefined
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json().catch(()=>null);
};

/* ---- MAP ---- */

const map=new maplibregl.Map({
  container:'map',
  style:{
    version:8,
    sources:{
      basemap:{type:'raster',tiles:[
        'https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png'
      ],tileSize:512}
    },
    layers:[{id:'osm',type:'raster',source:'basemap'}]
  },
  center:[18.06,59.33],
  zoom:13,
  bearing:0,
  pitch:0
});

map.on('load',()=>{

  /* ---- GPS ARROW ICON ---- */
  const svgArrow = `
  <svg width="46" height="46" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 2 L17 16 L12 13 L7 16 Z"
      fill="#1E90FF"
      stroke="none"
      filter="drop-shadow(0px 2px 3px rgba(0,0,0,0.55))" />
  </svg>`;

  const img = new Image();
  img.src = 'data:image/svg+xml;base64,' + btoa(svgArrow);
  img.onload = () => {
    map.addImage('gps-arrow', img, { pixelRatio: 2 });
  };

  /* GeoJSON */
  map.addSource('full',{type:'geojson',data:fc([])});
  map.addSource('seg',{type:'geojson',data:fc([])});
  map.addSource('trail',{type:'geojson',data:fc([])});
  map.addSource('gps',{type:'geojson',data:point(18.06,59.33,0)});

  map.addLayer({id:'full-line',type:'line',source:'full',paint:{'line-color':'#6A0DAD','line-width':4}});
  map.addLayer({id:'seg-line',type:'line',source:'seg',paint:{'line-color':['get','color'],'line-width':6}});
  map.addLayer({id:'trail-line',type:'line',source:'trail',paint:{'line-color':'#00ff55','line-width':6}});

  map.addLayer({
    id: 'gps-arrow-layer',
    type: 'symbol',
    source: 'gps',
    layout: {
      'icon-image': 'gps-arrow',
      'icon-size': 1.4,
      'icon-rotate': ['get','heading'],
      'icon-rotation-alignment': 'map',
      'icon-allow-overlap': true
    }
  });

  loadList();
});

/* ---- Helpers ---- */

const fc=feats=>({type:'FeatureCollection',features:feats});
const point=(lon,lat,heading)=>fc([{
  type:'Feature',
  geometry:{type:'Point',coordinates:[lon,lat]},
  properties:{heading}
}]);

const geoSrc=id=>map.getSource(id);
const setGeo=(id,data)=>geoSrc(id)?.setData(data);

/* ---- Routes ---- */

const loadList=async()=>{
  UI.select.innerHTML='<option>(läser...)</option>';
  try{
    const d=await gh(`/repos/${CFG.owner}/${CFG.repo}/contents/${CFG.folder}`);
    UI.select.innerHTML='<option value="">Välj rutt</option>';
    d.sort((a,b)=>b.name.localeCompare(a.name)).forEach(f=>{
      const o=document.createElement('option');
      o.value=f.path; o.textContent=f.name.replace(/\.json$/,'');
      UI.select.appendChild(o);
    });
  }catch{
    UI.select.innerHTML='<option>(tom)</option>';
  }
};

/* ---- Recording ---- */

UI.start.onclick=()=>{
  if(!navigator.geolocation) return alert('Ingen GPS');

  S.rec=true; S.currentPoints=[];
  UI.start.disabled=true; UI.stop.disabled=false; UI.save.disabled=true;

  setGeo('full',fc([]));
  setGeo('trail',fc([]));

  notify("Inspelning startad");

  S.watchId=navigator.geolocation.watchPosition(p=>{
    const pt={lat:p.coords.latitude,lon:p.coords.longitude,t:p.timestamp||Date.now()};
    S.currentPoints.push(pt);
    drawFull(); drawTrail();

    if (S.autoFollow) {
  map.easeTo({
    center: [u.lon, u.lat],
    bearing: S.lastHeading,
    zoom: map.getZoom(),
    duration: 320,
    easing: t => t * t * (3 - 2 * t)
  });
}

  },console.error,{enableHighAccuracy:true});
};

UI.stop.onclick=()=>{
  navigator.geolocation.clearWatch(S.watchId);
  S.rec=false;
  UI.start.disabled=false;
  UI.stop.disabled=true;
  UI.save.disabled=S.currentPoints.length<2;
  notify("Inspelning stoppad");
};

const drawFull=()=>setGeo('full',fc([{
  type:'Feature',
  geometry:{type:'LineString',coordinates:S.currentPoints.map(p=>[p.lon,p.lat])}
}]));

const drawTrail=()=>{
  const pts=S.currentPoints;
  if(pts.length<2) return setGeo('trail',fc([]));
  setGeo('trail',fc([{
    type:'Feature',
    geometry:{type:'LineString',coordinates:pts.slice(-2).map(p=>[p.lon,p.lat])}
  }]));
};

/* ---- Token ---- */

UI.setToken.onclick=()=>{
  const t=prompt('Klistra in din GitHub-token:');
  if(!t) return;
  S.pat=t.trim();
  sessionStorage.setItem('gh_pat',S.pat);
  notify("Token uppdaterad");
};

/* ---- Load route ---- */

UI.load.onclick=async()=>{
  if(!UI.select.value) return alert('Välj rutt');
  try{
    const f=await gh(`/repos/${CFG.owner}/${CFG.repo}/contents/${UI.select.value}`);
    S.loaded=JSON.parse(b64.dec(f.content));
    S.loadedPath=UI.select.value;

    buildSeg(S.loaded.points);
    zoomToRoute(S.loaded.points);
    notify("Rutt laddad");

  }catch(e){ alert('Fel: '+e); }
};

const buildSeg=pts=>{
  S.segments=[]; S.completed=[];
  for(let i=0;i<pts.length-1;i++){
    const a=pts[i],b=pts[i+1];
    S.segments.push({a,b,coords:[[a.lon,a.lat],[b.lon,b.lat]]});
    S.completed.push(false);
  }
  drawSegGradient();
};

const gradientColor=p=>{
  const r1=106,g1=13,b1=173;
  const r2=0,g2=255,b2=85;
  return `rgb(${Math.round(r1+(r2-r1)*p)},${Math.round(g1+(g2-g1)*p)},${Math.round(b1+(b2-b1)*p)})`;
};

const drawSegGradient=()=>{
  const feats=S.segments.map((s,i)=>{
    const pct=S.completed.slice(0,i+1).filter(x=>x).length/S.segments.length;
    return {type:'Feature',geometry:{type:'LineString',coordinates:s.coords},properties:{color:gradientColor(pct)}};
  });
  setGeo('seg',fc(feats));
};

/* ---- Reset progress ---- */

UI.reset.onclick=()=>{
  S.completed=S.completed.map(()=>false);
  drawSegGradient();
  notify("Progress återställd");
};

/* ---- Follow toggle ---- */

UI.follow.onclick=()=>{
  S.autoFollow=!S.autoFollow;
  UI.follow.textContent=S.autoFollow?'Följ: På':'Följ: Av';

  notify(S.autoFollow?"Följer: På":"Följer: Av");

  if (S.autoFollow && lastPos) {
  map.jumpTo({
    center: [lastPos.lon, lastPos.lat],
    bearing: S.lastHeading,
    zoom: map.getZoom(),
    pitch: 0
  });
}
};

/* ---- GPS smoothing ---- */

let lastPos=null;

const smooth = (cur, a = 0.12) => {
  if(!lastPos){ lastPos = {...cur}; return cur; }
  lastPos.lat += (cur.lat - lastPos.lat) * a;
  lastPos.lon += (cur.lon - lastPos.lon) * a;
  return lastPos;
};

const headingBetween=(p1,p2)=>{
  const y=Math.sin((p2.lon-p1.lon)*Math.PI/180)*Math.cos(p2.lat*Math.PI/180);
  const x=Math.cos(p1.lat*Math.PI/180)*Math.sin(p2.lat*Math.PI/180) -
    Math.sin(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.cos((p2.lon-p1.lon)*Math.PI/180);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
};

const livePosSmooth=p=>{
  const u=smooth({lat:p.coords.latitude,lon:p.coords.longitude});

  /* Smooth heading */
  if(lastPos){
    const target = headingBetween(lastPos,u);
    S.lastHeading = S.lastHeading + (target - S.lastHeading) * 0.15;
  }

  /* Update arrow graphic */
  setGeo('gps', point(u.lon,u.lat,S.lastHeading));

  /* Auto-follow + map rotation */
  if (S.autoFollow) {
  map.easeTo({
    center: [u.lon, u.lat],
    bearing: S.lastHeading,
    zoom: map.getZoom(),
    duration: 320,
    easing: t => t * t * (3 - 2 * t)
  });
}

  /* Progress */
  let best=-1,dist=Infinity;
  S.segments.forEach((s,i)=>{
    const d=hav(u,s.b);
    if(d<dist){dist=d; best=i;}
  });
  if(dist<25){
    S.completed[best]=true;
    drawSegGradient();
  }
};

/* ---- Fit route ---- */

const zoomToRoute=pts=>{
  const lons=pts.map(p=>p.lon),lats=pts.map(p=>p.lat);
  map.fitBounds([
    [Math.min(...lons),Math.min(...lats)],
    [Math.max(...lons),Math.max(...lats)]
  ],{padding:50,duration:800});
};

/* ---- Live GPS ---- */

if(navigator.geolocation){
  S.liveWatch=navigator.geolocation.watchPosition(
    livePosSmooth,
    console.warn,
    {enableHighAccuracy:true}
  );
}

/* ---- Toggle topbar ---- */

document.getElementById("toggleTopbar").onclick = () => {
  document.querySelector(".topbar").classList.toggle("hidden");
};

})();
</script>
</body>
</html>