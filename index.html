<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<title>GPS Tracker ‚Äî Sleek & Compact</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<meta name="theme-color" content="#000000" />
<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />

<style>
/* --- THEME & VARIABLES --- */
:root {
  --bg: #000000;
  --glass-bg: rgba(25, 25, 25, 0.7);
  --glass-border: rgba(255, 255, 255, 0.1);
  --glass-blur: blur(20px) saturate(180%);
  --accent: #00f2ff;
  --red: #ff2a6d;
  --green: #05ffa1;
  --text: #ffffff;
  --text-dim: #888;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body, html {
  margin: 0; padding: 0; width: 100%; height: 100%;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif;
  background: var(--bg); color: var(--text);
  overflow: hidden;
}

#map {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  z-index: 1;
}

/* --- FLOATING GLASS TOP BAR --- */
.ui-container {
  position: absolute; z-index: 100;
  top: 10px; left: 0; right: 0;
  display: flex;
  justify-content: center;
  pointer-events: none;
}

.glass-bar {
  pointer-events: auto;
  background: var(--glass-bg);
  backdrop-filter: var(--glass-blur);
  -webkit-backdrop-filter: var(--glass-blur);
  border: 1px solid var(--glass-border);
  border-radius: 99px; /* Pill shape */
  padding: 6px 12px; /* Tighter padding */
  
  display: flex;
  overflow-x: auto;
  align-items: center;
  gap: 6px;
  
  /* FIX: Width fits content exactly, but caps at screen width */
  width: max-content; 
  max-width: 95vw; 
  
  /* Transitions for collapse */
  transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
}

/* Hidden State */
.glass-bar.collapsed {
  opacity: 0;
  transform: translateY(-20px);
  pointer-events: none;
}

.glass-bar::-webkit-scrollbar { display: none; }

/* --- CONTROLS --- */
.glass-bar button, .glass-bar input, .glass-bar select {
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.05);
  color: #fff;
  font-size: 13px;
  font-weight: 600;
  padding: 8px 14px;
  border-radius: 99px; /* Pill buttons */
  white-space: nowrap;
  flex-shrink: 0;
  cursor: pointer;
  transition: all 0.2s;
  height: 38px;
}

.glass-bar button:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
.glass-bar button:active { transform: scale(0.95); }
.glass-bar button:disabled { opacity: 0.4; cursor: not-allowed; }

/* Specific Styles */
.btn-record { color: var(--green); border-color: rgba(5, 255, 161, 0.2); }
.btn-record.active { background: var(--green); color: #000; box-shadow: 0 0 12px rgba(5, 255, 161, 0.3); }

.btn-stop { color: var(--red); border-color: rgba(255, 42, 109, 0.2); }

.btn-follow-north { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
.btn-follow-nose { color: var(--accent); border-color: var(--accent); background: rgba(0, 242, 255, 0.1); }

/* Inputs */
.glass-bar input, .glass-bar select {
  background: rgba(0,0,0,0.4);
  min-width: 80px;
  padding-left: 12px;
  padding-right: 12px;
}

/* --- TOGGLE BUTTON --- */
#toggleBtn {
  position: absolute; top: 12px; right: 12px;
  z-index: 101;
  width: 40px; height: 40px;
  border-radius: 50%;
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  color: #fff;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  pointer-events: auto;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* --- STATUS & TOASTS --- */
.status-pill {
  position: absolute; bottom: 20px; left: 20px; z-index: 10;
  background: var(--glass-bg); backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  padding: 6px 14px; border-radius: 99px;
  font-size: 12px; font-weight: 600; color: var(--text-dim);
  display: flex; gap: 6px; align-items: center;
  pointer-events: auto;
}
.dot { width: 6px; height: 6px; background: #444; border-radius: 50%; }
.dot.on { background: var(--green); box-shadow: 0 0 6px var(--green); }

.toast-container {
  position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
  z-index: 200; pointer-events: none; display: flex; flex-direction: column; gap: 8px;
}
.toast {
  background: rgba(0,0,0,0.85); backdrop-filter: blur(12px);
  color: #fff; padding: 10px 20px;
  border-radius: 12px; font-size: 13px; border: 1px solid rgba(255,255,255,0.1);
  text-align: center;
  opacity: 0; transition: opacity 0.3s, transform 0.3s;
  transform: translateY(-10px);
}
.toast.show { opacity: 1; transform: translateY(0); }
</style>
</head>
<body>

<div id="map"></div>

<button id="toggleBtn" title="Visa/D√∂lj meny">‚ò∞</button>

<div class="ui-container">
  <div class="glass-bar" id="glassBar">
    
    <button id="btnFollow" style="width: 85px;">üß≠ Off</button>
    
    <!-- Spacers are implicit in gap, but we can keep a subtle divider if wanted. 
         Removed dividers for a cleaner pill look. -->
    
    <button id="btnStart" class="btn-record">‚óè REC</button>
    <button id="btnStop" class="btn-stop" disabled>‚ñ† STOP</button>
    
    <input id="inpName" placeholder="Namn..." />
    <button id="btnSave" disabled>Save</button>
    
    <select id="selRoutes"><option value="">Ladda...</option></select>
    <button id="btnLoad">‚¨á</button>
    <button id="btnReset">‚úï</button>
    
    <button id="btnToken">üîë</button>
  </div>
</div>

<div class="status-pill" id="tokenPill">
  <div class="dot" id="tokenDot"></div>
  <span id="tokenText">No Token</span>
</div>

<div class="toast-container" id="toastContainer"></div>

<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

<script>
const $ = id => document.getElementById(id);
const notify = (msg, ms=3000) => {
  const el = document.createElement('div');
  el.className = 'toast'; el.textContent = msg;
  $('toastContainer').appendChild(el);
  requestAnimationFrame(() => el.classList.add('show'));
  setTimeout(() => { el.classList.remove('show'); setTimeout(()=>el.remove(), 300); }, ms);
};

/**
 * ENGINE
 */
const Engine = (() => {
  const MODE = { OFF: 0, NORTH: 1, NOSE: 2 };
  let state = { mode: MODE.OFF, cur: {lat:0,lon:0,hdg:0}, tgt: {lat:0,lon:0,hdg:0}, hasFix: false };
  let map = null;

  function init(m) {
    map = m;
    map.on('load', () => {
      requestAnimationFrame(loop);
    });
  }

  function updateGPS(lat, lon, hdg) {
    state.tgt.lat = lat; state.tgt.lon = lon;
    state.tgt.hdg = (hdg !== null && !isNaN(hdg)) ? hdg : state.tgt.hdg;

    if (!state.hasFix) {
      state.cur = { ...state.tgt };
      state.hasFix = true;
      map.jumpTo({ center: [lon, lat], zoom: 15, bearing: 0, pitch: 0 });
    }
  }

  function toggleMode() {
    state.mode = (state.mode + 1) % 3;
    const btn = $('btnFollow');
    btn.className = ''; 
    
    if (state.mode === MODE.OFF) {
      btn.textContent = "üß≠ Off";
      btn.style.border = "1px solid rgba(255,255,255,0.05)";
      btn.style.background = "rgba(0,0,0,0.3)";
      btn.style.color = "#fff";
      notify("Follow Off");
    } else if (state.mode === MODE.NORTH) {
      btn.classList.add('btn-follow-north');
      btn.textContent = "üß≠ North";
      notify("North Up");
      map.easeTo({ bearing: 0, pitch: 0, duration: 500 });
    } else if (state.mode === MODE.NOSE) {
      btn.classList.add('btn-follow-nose');
      btn.textContent = "üß≠ Nose";
      notify("Nose Up");
      map.easeTo({ pitch: 0, duration: 500 });
    }
  }

  const lerp = (a,b,t) => a + (b-a)*t;
  const lerpAng = (a,b,t) => {
    let d = (b - a + 540) % 360 - 180;
    return (a + d*t + 360) % 360;
  };

  function loop() {
    if (state.hasFix) {
      state.cur.lat = lerp(state.cur.lat, state.tgt.lat, 0.25);
      state.cur.lon = lerp(state.cur.lon, state.tgt.lon, 0.25);
      state.cur.hdg = lerpAng(state.cur.hdg, state.tgt.hdg, 0.25);

      const src = map.getSource('gps-src');
      if(src) {
        src.setData({
          type: 'FeatureCollection',
          features: [{
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [state.cur.lon, state.cur.lat] },
            properties: { bearing: state.cur.hdg }
          }]
        });
      }

      if (state.mode !== MODE.OFF) {
        let bearing = 0;
        if (state.mode === MODE.NOSE) bearing = state.cur.hdg;
        
        map.easeTo({
          center: [state.cur.lon, state.cur.lat],
          bearing: bearing,
          pitch: 0,
          zoom: map.getZoom(),
          duration: 0
        });
      }
    }
    requestAnimationFrame(loop);
  }

  return { init, updateGPS, toggleMode, hasFix: () => state.hasFix };
})();

/**
 * APP CONTROLLER
 */
(() => {
  const cfg = { owner: "MasterBenDover", repo: "gps-tracker", path: "routes", branch: "main" };
  let PAT = sessionStorage.getItem('gh_pat');
  let rec = false; let rawPts = [];
  
  const ui = {
    start: $('btnStart'), stop: $('btnStop'), save: $('btnSave'),
    load: $('btnLoad'), reset: $('btnReset'), token: $('btnToken'),
    follow: $('btnFollow'), name: $('inpName'), sel: $('selRoutes'),
    tDot: $('tokenDot'), tText: $('tokenText'),
    bar: $('glassBar'), toggle: $('toggleBtn')
  };

  ui.toggle.addEventListener('click', () => { ui.bar.classList.toggle('collapsed'); });

  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        dark: { type: 'raster', tiles: ['https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png'], tileSize: 256 }
      },
      layers: [{ id: 'dark', type: 'raster', source: 'dark' }]
    },
    center: [18.06, 59.33], zoom: 13,
    bearing: 0, pitch: 0
  });
  Engine.init(map);

  map.on('load', () => {
    map.addSource('gps-src', { type: 'geojson', data: {type:'FeatureCollection',features:[]} });
    map.addSource('trail-src', { type: 'geojson', data: {type:'FeatureCollection',features:[]} });
    map.addSource('route-src', { type: 'geojson', data: {type:'FeatureCollection',features:[]} });

    map.addLayer({
      id: 'trail', type: 'line', source: 'trail-src',
      paint: { 'line-color': '#05ffa1', 'line-width': 4 }
    });
    map.addLayer({
      id: 'route', type: 'line', source: 'route-src',
      paint: { 'line-color': '#ff2a6d', 'line-width': 4 }
    });

    // --- SLEEK TRIANGLE ARROW (Cyan) ---
    const arrowSvg = `
    <svg width="64" height="64" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
          <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.6"/>
        </filter>
      </defs>
      <path d="M12 2 L22 22 H2 L12 2 Z" fill="#00f2ff" filter="url(#shadow)" />
      <circle cx="12" cy="15" r="1.5" fill="#000" opacity="0.5"/>
    </svg>`;
    
    const img = new Image();
    img.onload = () => {
      map.addImage('triangle-icon', img);
      map.addLayer({
        id: 'arrow-layer', type: 'symbol', source: 'gps-src',
        layout: {
          'icon-image': 'triangle-icon',
          'icon-size': 0.6,
          'icon-rotate': ['get', 'bearing'],
          'icon-rotation-alignment': 'map',
          'icon-allow-overlap': true
        }
      });
    };
    img.src = 'data:image/svg+xml;base64,' + btoa(arrowSvg);

    updateToken();
    loadList();
  });

  // --- GPS ---
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(p => {
      const { latitude, longitude, heading } = p.coords;
      const hdg = (heading !== null && !isNaN(heading)) ? heading : (Engine.hasFix() ? Engine.hasFix().hdg : 0);
      Engine.updateGPS(latitude, longitude, hdg);

      if(rec) {
        rawPts.push({ lat: latitude, lon: longitude, t: Date.now() });
        if(rawPts.length > 1) {
          const coords = rawPts.map(pt => [pt.lon, pt.lat]);
          map.getSource('trail-src').setData({
            type: 'FeatureCollection',
            features: [{ type: 'Feature', geometry: { type: 'LineString', coordinates: coords } }]
          });
          ui.save.disabled = false;
        }
      }
    }, e => notify('GPS Err'), { 
      enableHighAccuracy: true, 
      timeout: 5000, 
      maximumAge: 0 
    });
  }

  // --- EVENTS ---
  ui.follow.addEventListener('click', () => Engine.toggleMode());
  map.on('dragstart', () => { 
    const btn = $('btnFollow');
    btn.className = ''; btn.style.border="1px solid rgba(255,255,255,0.05)"; 
    btn.style.background="rgba(0,0,0,0.3)"; btn.style.color="#fff"; btn.textContent="üß≠ Off";
  });

  ui.start.addEventListener('click', () => {
    if(!Engine.hasFix()) return notify("V√§ntar p√• GPS...");
    rec = true; rawPts = [];
    ui.start.disabled = true; ui.stop.disabled = false; ui.save.disabled = true; ui.name.disabled = true;
    ui.start.classList.add('active');
    map.getSource('trail-src').setData({type:'FeatureCollection',features:[]});
    map.getSource('route-src').setData({type:'FeatureCollection',features:[]});
    notify("Inspelning startad");
  });

  ui.stop.addEventListener('click', () => {
    rec = false;
    ui.start.disabled = false; ui.stop.disabled = true; ui.name.disabled = false;
    ui.start.classList.remove('active');
    notify("Stoppade ("+rawPts.length+")");
  });

  ui.reset.addEventListener('click', () => {
    map.getSource('trail-src').setData({type:'FeatureCollection',features:[]});
    map.getSource('route-src').setData({type:'FeatureCollection',features:[]});
    rawPts = []; ui.save.disabled = true;
  });

  ui.token.addEventListener('click', () => {
    const t = prompt("GitHub Token:");
    if(t){ PAT=t; sessionStorage.setItem('gh_pat',PAT); updateToken(); loadList(); notify("Token sparad"); }
  });

  function updateToken() {
    if(PAT){ ui.tDot.classList.add('on'); ui.tText.textContent="Token OK"; }
    else { ui.tDot.classList.remove('on'); ui.tText.textContent="No Token"; }
  }

  const utf8_b64 = s => btoa(unescape(encodeURIComponent(s)));
  const b64_utf8 = b => decodeURIComponent(escape(atob(b)));

  async function gh(p,m,b) {
    const h={'Accept':'application/vnd.github.v3+json'};
    if(PAT) h['Authorization']='token '+PAT;
    if(b) h['Content-Type']='application/json';
    const r=await fetch('https://api.github.com'+p,{method:m,headers:h,body:b?JSON.stringify(b):null});
    if(!r.ok) throw new Error(r.statusText);
    return r.json();
  }

  async function loadList() {
    try {
      const f = await gh(`/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.path}`);
      ui.sel.innerHTML='<option value="">-- V√§lj --</option>';
      f.filter(x=>x.name.endsWith('.json')).forEach(x=>{
        const o=document.createElement('option'); o.value=x.path; o.textContent=x.name.replace('.json','');
        ui.sel.appendChild(o);
      });
    }catch(e){}
  }

  ui.save.addEventListener('click',async()=>{
    const n=ui.name.value.trim(); if(!n) return alert("Ange namn");
    const p=`${cfg.path}/${n}.json`;
    const c=utf8_b64(JSON.stringify({name:n,points:rawPts}));
    try{
      let s=null;
      try{s=(await gh(`/repos/${cfg.owner}/${cfg.repo}/contents/${p}`)).sha}catch(e){}
      await gh(`/repos/${cfg.owner}/${cfg.repo}/contents/${p}`,'PUT',{message:"Route",content:c,branch:cfg.branch,sha:s});
      notify("Sparad!");
      loadList();
    }catch(e){alert("Err: "+e.message);}
  });

  ui.load.addEventListener('click',async()=>{
    if(!ui.sel.value)return;
    try{
      const f=await gh(`/repos/${cfg.owner}/${cfg.repo}/contents/${ui.sel.value}`);
      const d=JSON.parse(b64_utf8(f.content));
      const coords=d.points.map(x=>[x.lon,x.lat]);
      map.getSource('route-src').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'LineString',coordinates:coords}}]});
      map.fitBounds(coords.reduce((b,c)=>b.extend(c),new maplibregl.LngLatBounds(coords[0],coords[0])),{padding:50});
      notify("Rutt laddad");
    }catch(e){alert("Err"); }
  });

})();
</script>
</body>
</html>